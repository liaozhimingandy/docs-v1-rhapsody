<!doctype html>
<html>
 <head> 
  <title>Inserting Patient Information Into Multiple Tables Using SQL Server</title> 
  <link rel="stylesheet" href="styles/site.css" type="text/css"> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
  <link rel="stylesheet" href="styles/icons.css" type="text/css">
  <script src="js/jquery.min.js"></script>
  <script src="tree/collapsibleTreeMenu.js"></script>
  <link href="tree/collapsibleTreeMenu.css" rel="stylesheet" type="text/css">
 </head> 
 <body class="theme-default aui-theme-default"> 
  <div id="page"> 
   <div id="main" class="aui-page-panel"> 
    <div id="main-header"> 
     <div id="breadcrumb-section"> 
      <ol id="breadcrumbs">  
       <li> <span><a href="Rhapsody-Integration-Engine-6.5_133160975.html">Rhapsody Integration Engine 6.5</a></span> </li> 
       <li> <span><a href="Developing-Rhapsody_133161055.html">Developing Rhapsody</a></span> </li> 
       <li> <span><a href="Rhapsody-Objects_133161790.html">Rhapsody Objects</a></span> </li> 
       <li> <span><a href="Rhapsody-Components_133161994.html">Rhapsody Components</a></span> </li> 
       <li> <span><a href="Communication-Points_133162164.html">Communication Points</a></span> </li> 
       <li> <span><a href="Communication-Point-Types_133162205.html">Communication Point Types</a></span> </li> 
       <li> <span><a href="Database-Communication-Points_133162442.html">Database Communication Points</a></span> </li> 
       <li> <span><a href="Database_133162443.html">Database</a></span> </li> 
       <li> <span><a href="Using-the-Database-Communication-Point_133162447.html">Using the Database Communication Point</a></span> </li> 
      </ol> 
     </div> 
     <h1 id="title-heading" class="pagetitle"> <span id="title-text">Inserting Patient Information Into Multiple Tables Using SQL Server</span> </h1> 
    </div> 
    <div id="content" class="view">  
     <div id="main-content" class="wiki-content group"> 
      <p>This scenario involves taking HL7 messages and storing some information from the message into an SQL database. Specifically, the patient identifier, name, address, next of kin, and next of kin's address are inserted into appropriate database tables. The scenario handles the case where the patient may have multiple addresses, or multiple designated people as their next of kin. In addition, each next of kin can have multiple addresses.</p> 
      <p>The patient information can be found in the <code>HL7 PID</code> segment and the <code>Next of Kin</code> information can be found in the <code>NK1</code> segment.</p> 
      <p>This scenario is for SQL Server, but can be adapted to Oracle® with minor changes. Both the SQL Server and Oracle® versions of this scenario can be loaded as samples into the <strong>Rhapsody Database Configuration Editor</strong> from the <strong>Samples</strong> menu.</p> 
      <p>As there are four sets of data and four tables to insert into, four statements are required. As all tables require the patient identifier, either directly or indirectly (the <strong>NextOfKinAddress</strong> table requires a value from the <strong>NextOfKin</strong> table, which in turn requires the <code>PatientID</code>, the insert into the patient table must occur first, and the identifier retrieved.</p> 
      <p>As the requirement is to insert all patient addresses, all next of kins, and all of the next of kins' addresses, some statement iteration is required to loop over the repeating elements in the message. Two levels of iteration are required for the next of kin address in order to get all addresses for all next of kins.</p> 
      <p>This gives a configuration outline as follows:</p> 
      <ul> 
       <li><em>Statement One:</em> Insert the patient name information into the Patient table, and retrieve the new identifier generated by the database so it can be used in subsequent statements.</li> 
       <li><em>Statement Two:</em> Iterate over all repeats of the patient address, and insert each address into the Address table.</li> 
       <li><em>Statement Three:</em> Iterate over all repeats of the patient's next of kins, and insert each next of kin into the <strong>NextOfKin</strong> table.</li> 
       <li><em>Statement Four:</em> This is a child statement of statement three (so it implicitly repeats over all next of kins), and also iterates over each next of kin address. These are each inserted into the <strong>NextOfKinAddress</strong> table.</li> 
      </ul> 
      <h2 id="InsertingPatientInformationIntoMultipleTablesUsingSQLServer-InsertingIntothePatientTable">Inserting Into the Patient Table</h2> 
      <p>Start with a new configuration in the <strong>Rhapsody Database Configuration Editor</strong>, and drag a new statement onto the editor, as shown in the following diagram.</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162451.png" data-image-src="attachments/133162448/133162451.png" data-unresolved-comment-count="0" data-linked-resource-id="133162451" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="firstStatementSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Edit the statement by double-clicking on it or by clicking the <strong>Edit Statement</strong> icon. Rename the statement to <em>Insert Patient</em> by clicking the <strong>Rename</strong> link at the top of the dialog.</p> 
      <p>Generate an <code>INSERT</code> statement by selecting the <strong>Patient</strong> table from the Server Explorer, and choosing to generate an SQL statement as shown in the following diagram:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162452.png" data-image-src="attachments/133162448/133162452.png" data-unresolved-comment-count="0" data-linked-resource-id="133162452" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="generatingPatientInsertSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>The generated SQL INSERT statement looks like this:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162453.png" data-image-src="attachments/133162448/133162453.png" data-unresolved-comment-count="0" data-linked-resource-id="133162453" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertPatientJustGeneratedSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>This generates the outline of the SQL statement, but needs some modification to use the values from the input message. Modify the statement by removing the PatientID column (as this is automatically generated by SQL Server), and dragging the appropriate fields from the PID segment in the <code>ADTA01</code> message from the Message Structure toolbox.</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162450.png" data-image-src="attachments/133162448/133162450.png" data-unresolved-comment-count="0" data-linked-resource-id="133162450" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertPatientDraggingFieldSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Drag the <code>PID/PatientName/FamilyName</code>, <code>PID/PatientName/GivenName</code>, <code>PID/PatientName/Prefix</code>, and <code>PID/Sex</code> fields onto the text editor, replacing the appropriate message properties that were automatically generated. The SQL should now look like this:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162449.png" data-image-src="attachments/133162448/133162449.png" data-unresolved-comment-count="0" data-linked-resource-id="133162449" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertPatientAfterFieldsUpdatedSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Now the automatically generated identifier needs to be retrieved from the database so it can be used in subsequent queries. This is done by retrieving the special <code>@@IDENTITY</code> value from SQL Server and calling it <code>PatientID</code>. Subsequent queries can refer to it as if it were a column returned from a normal query.</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162456.png" data-image-src="attachments/133162448/133162456.png" data-unresolved-comment-count="0" data-linked-resource-id="133162456" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertPatientSqlFinalSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Finally enter a short summary for the statement so it is easy to refer to later. This has no effect on how the configuration works, but makes it much simpler to refer to the configuration later and remember how it works.</p> 
      <h2 id="InsertingPatientInformationIntoMultipleTablesUsingSQLServer-InsertingIntotheAddressTable">Inserting Into the Address Table</h2> 
      <p>In the <strong>Overview Editor</strong>, create a new statement by dragging it underneath the <code>Insert Patient</code> statement. As all addresses need to be inserted, this statement needs to iterate over all addresses in the message. Click the <strong>Statement Iteration</strong> icon as shown below to select the iteration path.</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162457.png" data-image-src="attachments/133162448/133162457.png" data-unresolved-comment-count="0" data-linked-resource-id="133162457" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertAddressIterationLinkSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>This shows the field path selector dialog. Browse to the <code>ADTA01</code> message, and select the <code>PID/PatientAddress</code> repeating field, and click the <strong>OK</strong> button. This is shown below:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162458.png" data-image-src="attachments/133162448/133162458.png" data-unresolved-comment-count="0" data-linked-resource-id="133162458" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertAddressIterationPathSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Open the new statement, rename it to <em>Insert Patient Address</em>, then generate an <code>INSERT</code> statement selecting the <strong>Address</strong> table from the Server Explorer and pressing the <strong>Generate</strong> button. The result of this is shown below:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162455.png" data-image-src="attachments/133162448/133162455.png" data-unresolved-comment-count="0" data-linked-resource-id="133162455" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertAddressJustGeneratedSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Modify the SQL by removing the reference to <code>AddressID</code> (as it is automatically generated by the database), change the value to be inserted into the <strong>PatientId</strong> column to <code>@PatientID</code> to use the identifier generated by the previous statement, and then update all the remaining values to the appropriate values in the <code>PID/PatientAddress</code> composite. These can be dragged into the text editor from the Message Structure toolbox. Ultimately the SQL should look like this:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162454.png" data-image-src="attachments/133162448/133162454.png" data-unresolved-comment-count="0" data-linked-resource-id="133162454" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertAddressSqlFinalSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Finally, give the statement a summary to describe its behavior, and close the SQL Editor.</p> 
      <h2 id="InsertingPatientInformationIntoMultipleTablesUsingSQLServer-InsertingIntotheNextOfKinTable">Inserting Into the NextOfKin Table</h2> 
      <p>In the overview editor, create a new statement by dragging it underneath the <em>Insert Patient Address</em> statement. As all next of kins need to be inserted, this statement needs to iterate over all the next of kins in the message. Click the <strong>Statement Iteration</strong> icon and select the repeating <code>NK1</code> segment within the <code>ADTA01</code> message. Click the <strong>OK</strong> button to close the dialog. The result of this is shown in the following diagram:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162461.png" data-image-src="attachments/133162448/133162461.png" data-unresolved-comment-count="0" data-linked-resource-id="133162461" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1AfterIterationSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Open the new statement, rename it to <em>Insert Next Of Kin</em>, then generate an INSERT statement by selecting the <strong>NextOfKin</strong> table in the Server Explorer and then click the <strong>Generate SQL</strong> button. The result of this is shown in the following diagram:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162463.png" data-image-src="attachments/133162448/133162463.png" data-unresolved-comment-count="0" data-linked-resource-id="133162463" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1AddressJustGeneratedSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Modify the SQL by removing the reference to <code>NextOfKinID</code> (as it is automatically generated by the database), and change the value to be inserted into the <strong>PatientId</strong> column to <code>@PatientID</code> to use the identifier generated by the first statement. Then update all remaining values to the appropriate values in the <code>NK1</code> segment (<code>NK1/NextOfKinName/FamilyName</code>, <code>NK1/NextOfKinName/GivenName</code>, <code>NK1/Sex</code>, <code>NK1/Relationship</code>, and <code>NK1/PhoneNumber</code>). The result of this is shown in the following diagram.</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162462.png" data-image-src="attachments/133162448/133162462.png" data-unresolved-comment-count="0" data-linked-resource-id="133162462" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1AfterFieldsSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Now the automatically generated identifier needs to be retrieved from the database so it can be used in subsequent queries. This is done by retrieving the special <code>@@IDENTITY</code> value from SQL Server and calling it <code>NextOfKinID</code>. Subsequent queries can refer to it as if it were a column returned from a normal query.</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162460.png" data-image-src="attachments/133162448/133162460.png" data-unresolved-comment-count="0" data-linked-resource-id="133162460" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1SqlFinalSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Finally, give the statement a summary to describe its behavior, and close the SQL Editor.</p> 
      <h2 id="InsertingPatientInformationIntoMultipleTablesUsingSQLServer-InsertingintotheNextOfKinAddresstable">Inserting into the NextOfKinAddress table</h2> 
      <p>In the overview editor, create a new statement by dragging it underneath the <strong>Insert Next Of Kin</strong> statement. As all addresses for each next of kin need to be inserted, use the <strong>Indent</strong> icon to move the new statement in one level. Then click the <strong>Statement Iteration</strong> icon and select the repeating <code>NK1/Address</code> field. Press the <strong>OK</strong> button to close the dialog. The result of this is shown in the following diagram:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162459.png" data-image-src="attachments/133162448/133162459.png" data-unresolved-comment-count="0" data-linked-resource-id="133162459" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1AddressAfterIterationSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Open the new statement, rename it to <em>Insert Next Of Kin Address</em>, then generate an <code>INSERT</code> statement by selecting the <strong>NextOfKin</strong> table in the Server Explorer and clicking the <strong>Generate</strong> button. The result of this is shown below:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162463.png" data-image-src="attachments/133162448/133162463.png" data-unresolved-comment-count="0" data-linked-resource-id="133162463" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1AddressJustGeneratedSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Modify the SQL by removing the reference to the <code>AddressID</code> (as it is automatically generated by the database), and change the value to be inserted into the <strong>NextOfKinID</strong> column to <code>@NextOfKinID</code> to use the identifier generated by the previous statement. Then update all the remaining values to the appropriate values in the <code>NK1/Address</code> field (<code>NK1/Address/StreetAddress</code>, <code>NK1/Address/City</code>, <code>NK1/Address/StateOrProvince</code>, and <code>NK1/Address/Country</code>). The result of this is shown in the following diagram:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162464.png" data-image-src="attachments/133162448/133162464.png" data-unresolved-comment-count="0" data-linked-resource-id="133162464" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="insertNK1AddressAfterFieldsSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
      <p>Finally, give the statement a summary to describe its behavior, and close the SQL Editor. The final configuration is shown in the following diagram:</p> 
      <p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" src="attachments/133162448/133162465.png" data-image-src="attachments/133162448/133162465.png" data-unresolved-comment-count="0" data-linked-resource-id="133162465" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="finalSqlServer.png" data-base-url="https://docs.rhapsody.health" data-linked-resource-content-type="image/png" data-linked-resource-container-id="133162448" data-linked-resource-container-version="1"></span></p> 
     </div>  
    </div> 
   </div>  
  </div>   
 </body>
</html>